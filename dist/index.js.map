{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["export interface MappedConfig {\n  [key: string]: any | string | undefined | MappedConfig\n}\n\nexport interface TransformFn {\n  (envValue: string): any\n}\n\nexport type TransformTuple = [string, TransformFn]\n\nexport interface ConfigWithEnvKeys {\n  [key: string]: string | InsertValue | TransformTuple | ConfigWithEnvKeys\n}\n\ninterface VerifyParamCollection {\n  config: ConfigWithEnvKeys\n  env: { [key: string]: string | undefined }\n  errors?: Error[]\n  path?: string\n}\n\nexport interface VerifiedConfig {\n  [key: string]: any | string | VerifiedConfig\n}\n\nclass InsertValue {\n  value: any\n  constructor(value: any) {\n    this.value = value\n  }\n}\n\nconst recursiveVerify = ({\n  config,\n  env,\n  errors = [] as Error[],\n  path = ''\n}: VerifyParamCollection): VerifyParamCollection => {\n  const mapConf = (key: string): ConfigWithEnvKeys => {\n    const value = config[key]\n    const subPath = path.length === 0 ? key : `${path}.${key}`\n\n    const getValueFromEnv = (key: string): string => {\n      const envValue = env[key]\n      if (envValue === undefined || envValue.length === 0) {\n        errors.push(\n          new Error(\n            `environment value ${key} is missing from config object at ${subPath}`\n          )\n        )\n        return undefined\n      }\n      return envValue\n    }\n\n    if (value instanceof InsertValue) {\n      return { [key]: value.value }\n    } else if (Array.isArray(value)) {\n      const [envKey, transformFn] = value as TransformTuple\n\n      const envValue = getValueFromEnv(envKey)\n\n      const transforedValue = envValue && transformFn(envValue)\n\n      return { [key]: transforedValue }\n    } else if (typeof value === 'string') {\n      const envValue = getValueFromEnv(value as string)\n\n      return { [key]: envValue }\n    } else {\n      const { errors: subErrors, config: subConfig } = recursiveVerify({\n        config: value,\n        env,\n        path: subPath\n      })\n\n      errors = errors.concat(subErrors)\n      return { [key]: subConfig }\n    }\n  }\n  const reduceConf = (acc: ConfigWithEnvKeys, obj: ConfigWithEnvKeys) => ({\n    ...acc,\n    ...obj\n  })\n  const mappedConf = Object.keys(config).map(mapConf)\n  const newConfig = mappedConf.reduce(reduceConf, {} as ConfigWithEnvKeys)\n\n  return { config: newConfig, env, errors, path }\n}\n\nexport function verify(\n  config: ConfigWithEnvKeys,\n  env: { [key: string]: string | undefined } = process.env\n): { config: MappedConfig; errors: string[] } {\n  const { config: builtConfig, errors } = recursiveVerify({ config, env })\n\n  const errorMessages = errors.map(\n    ({ message }: { message: string }) => message\n  )\n\n  return { config: builtConfig, errors: errorMessages }\n}\n\nexport function strictVerify(\n  config: ConfigWithEnvKeys,\n  env: { [key: string]: string | undefined } = process.env\n): VerifiedConfig {\n  const { config: builtConfig, errors } = verify(config, env)\n\n  if (errors.length > 0) {\n    throw new Error(`Missing configuration values: ${errors.join('\\n')}`)\n  }\n  return builtConfig as VerifiedConfig\n}\n\nexport function insert(value: any): InsertValue {\n  return new InsertValue(value)\n}\n"]}